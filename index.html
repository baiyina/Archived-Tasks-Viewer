<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Archived Tasks Viewer</title>
    <style>
      :root {
        --bg: #f8f8f7;
        --card: #ffffff;
        --muted: #4b5563;
        --border: rgba(0, 0, 0, 0.08);
        --accent: #3b82f6;
        --accent-bg: rgba(59, 130, 246, 0.12);
        --accent-border: rgba(59, 130, 246, 0.28);
        --accent-text: #1d4ed8;
        --grad1: transparent;
        --grad2: transparent;
        --surface-1: #f3f4f6;
        --surface-2: #eef1f7;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        --radius: 12px;
        --text: #1f2937;
        --focus-outline: rgba(59, 130, 246, 0.35);
        --focus-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
        --backdrop: rgba(0, 0, 0, 0.6);
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Inter, "Segoe UI", system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 16px 12px;
        background: var(--bg);
        color: var(--text, #e6edf7);
      }
      .page {
        max-width: 1180px;
        margin: 0 auto;
      }
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        margin-bottom: 10px;
      }
      h1 {
        margin: 0;
        font-size: 21px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .header-actions {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        flex: 0 0 auto;
      }
      .header-actions .muted {
        font-size: 13px;
        white-space: nowrap;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--accent-bg);
        border: 1px solid var(--accent-border);
        color: var(--accent-text);
        font-size: 12px;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-end;
        gap: 10px;
        margin-bottom: 12px;
      }
      .segmented {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: var(--surface-1);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 8px;
        height: 38px;
      }
      .seg-btn {
        border: 0;
        background: transparent;
        color: var(--muted);
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 13px;
        height: 30px;
        cursor: pointer;
        transition: all 0.12s ease;
        white-space: nowrap;
      }
      .seg-btn.active {
        background: var(--accent-bg);
        border: 1px solid var(--accent-border);
        color: var(--accent-text);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.08);
      }
      .seg-btn:hover:not(.active) {
        color: var(--text);
      }
      .seg-compact .seg-btn {
        padding: 4px 10px;
        height: 28px;
        font-size: 12px;
      }
      .hide {
        display: none !important;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
        color: var(--muted);
        font-size: 12px;
        min-width: 220px;
        flex: 1;
      }
      .segmented-field {
        min-width: 260px;
        flex: 0 0 auto;
      }
      .field-inline {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 13px;
      }
      input,
      select,
      button {
        background: var(--card);
        color: inherit;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0 12px;
        font-size: 13px;
        height: 38px;
        line-height: 1.05;
      }
      select {
        appearance: none;
        background-image: linear-gradient(45deg, transparent 50%, var(--muted) 50%),
          linear-gradient(135deg, var(--muted) 50%, transparent 50%),
          linear-gradient(to right, transparent, transparent);
        background-position: calc(100% - 18px) calc(50% - 3px),
          calc(100% - 12px) calc(50% - 3px),
          calc(100% - 44px) 0.35em;
        background-size: 6px 6px, 6px 6px, 1px 1.2em;
        background-repeat: no-repeat;
        padding-right: 42px;
      }
      input:focus,
      select:focus {
        outline: 1px solid var(--focus-outline);
        box-shadow: var(--focus-shadow);
      }
      button {
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease;
      }
      button.primary {
        background: linear-gradient(180deg, var(--accent-bg), var(--surface-1));
        border: 1px solid var(--accent-border);
        color: var(--accent-text);
        font-weight: 800;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
      }
      button.primary:hover {
        background: linear-gradient(180deg, var(--accent-bg), var(--surface-2));
      }
      button.ghost {
        background: transparent;
        border: 1px solid var(--border);
      }
      .btn-sm {
        height: 34px;
        border-radius: 999px;
        padding: 0 12px;
        font-size: 13px;
      }
      button.theme-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        background: linear-gradient(180deg, var(--accent-bg), var(--surface-1));
        border: 1px solid var(--accent-border);
        color: var(--accent-text);
        padding: 0 12px;
        height: 34px;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.12);
        transition: transform 0.15s ease, border-color 0.15s ease, background 0.15s ease;
      }
      button.theme-btn:hover {
        border-color: var(--accent-border);
        background: linear-gradient(180deg, var(--accent-bg), var(--surface-2));
      }
      button.theme-btn:active {
        transform: translateY(1px);
      }
      button.theme-btn svg {
        width: 16px;
        height: 16px;
        flex: 0 0 auto;
      }
      .theme-label {
        font-weight: 800;
        font-size: 13px;
        letter-spacing: 0.2px;
      }
      .btn-xs {
        height: 28px;
        padding: 0 10px;
        font-size: 12px;
        border-radius: 999px;
        line-height: 1;
      }
      .row-actions {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .status {
        margin: 6px 0 16px;
        color: var(--muted);
      }
      .group {
        margin-bottom: 18px;
      }
      .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 6px;
      }
      .group-title {
        font-weight: 700;
        letter-spacing: 0.1px;
      }
      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .task-row {
        display: flex;
        gap: 10px;
        align-items: stretch;
        padding: 10px 12px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        transition: border-color 0.12s ease, transform 0.12s ease;
      }
      .task-row:hover {
        border-color: var(--accent-border);
        transform: translateY(-1px);
      }
      .task-accent {
        width: 6px;
        border-radius: 999px;
        background: var(--accent);
        opacity: 0.8;
        flex-shrink: 0;
      }
      .task-main {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
      }
      .task-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
      }
      .task-title {
        font-weight: 750;
        font-size: 15px;
        line-height: 1.4;
        margin: 0;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 999px;
        background: var(--surface-2);
        border: 1px solid var(--border);
      }
      .pill.accent {
        background: var(--accent-bg);
        border-color: var(--accent-border);
        color: var(--accent-text);
      }
      .meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        color: var(--muted);
        font-size: 12px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 7px;
        border-radius: 999px;
        background: var(--surface-2);
        color: var(--text);
        font-size: 11px;
        border: 1px solid var(--border);
      }
      .task-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
      }
      .section {
        border-top: 1px solid var(--border);
        padding-top: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .section-title {
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .tree {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .tree-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto auto auto auto;
        gap: 8px;
        align-items: center;
        padding: 8px 10px;
        border-radius: 8px;
        background: var(--surface-1);
        border: 1px solid var(--border);
      }
      .tree-title {
        min-width: 0;
        font-weight: 600;
        line-height: 1.4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tree-row .muted {
        justify-self: end;
      }
      .tree-indent-0 {
        margin-left: 0;
      }
      .tree-indent-1 {
        margin-left: 12px;
      }
      .tree-indent-2 {
        margin-left: 24px;
      }
      .tree-indent-3 {
        margin-left: 36px;
      }
      .tree-indent-4 {
        margin-left: 48px;
      }
      .subtasks,
      .attachments {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .subtask-preview {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 4px;
      }
      .subtask-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 8px;
        border-radius: 9px;
        background: var(--surface-1);
        border: 1px solid var(--border);
        font-size: 11px;
      }
      .subtask,
      .attachment {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: 10px;
        background: var(--surface-1);
        border: 1px solid var(--border);
      }
      .subtask-title {
        min-width: 0;
        font-weight: 600;
        line-height: 1.4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .subtask .row-actions {
        justify-content: flex-end;
      }
      .subtask-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent-border);
        flex: 0 0 auto;
        box-shadow: 0 0 0 4px var(--surface-2);
      }
      .subtask-main {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 0;
      }
      .subtask-meta {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        color: var(--muted);
        font-size: 13px;
      }
      .attachment a {
        color: inherit;
        text-decoration: none;
      }
      .notes {
        margin: 0;
        white-space: pre-wrap;
        color: var(--text, #e6edf7);
        line-height: 1.5;
      }
      .muted {
        color: var(--muted);
      }
      .actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tight {
        gap: 6px;
      }
      /* Calendar */
      .calendar-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      .calendar-toolbar .left,
      .calendar-toolbar .right {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .calendar-toolbar .range-label {
        font-weight: 700;
        font-size: 14px;
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 8px;
      }
      .calendar-day {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px;
        height: 220px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .calendar-day-week {
        height: 520px;
      }
      .calendar-day-month {
        height: 200px;
      }
      .calendar-day.today {
        border-color: var(--accent-border);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
      }
      .calendar-day-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
        font-size: 13px;
      }
      .calendar-day-header .muted {
        font-weight: 500;
      }
      .calendar-task {
        background: var(--surface-1);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 6px 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .calendar-task-title {
        font-weight: 650;
        font-size: 13px;
        margin: 0;
        line-height: 1.3;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .calendar-empty {
        color: var(--muted);
        font-size: 12px;
      }
      .calendar-day-body {
        display: flex;
        flex-direction: column;
        gap: 6px;
        overflow: auto;
        flex: 1;
        min-height: 0;
        padding-right: 4px;
      }
      .truncate {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      /* Modal */
      #modal-root {
        position: fixed;
        inset: 0;
        pointer-events: none;
      }
      .backdrop {
        position: fixed;
        inset: 0;
        background: var(--backdrop);
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 32px 18px;
        pointer-events: auto;
        z-index: 10;
      }
      .modal {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        width: min(900px, 100%);
        padding: 18px;
        max-height: calc(100vh - 64px);
        overflow: auto;
        color: var(--text);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
      }
      .close-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: inherit;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
      }
      .kv {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 8px;
        margin: 8px 0 12px;
      }
      .kv-item {
        background: var(--surface-1);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
      }
      .kv-label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .kv-value {
        font-weight: 600;
      }
      @media (max-width: 540px) {
        .title-row {
          flex-direction: column;
          align-items: flex-start;
        }
        .card-footer {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="topbar">
        <h1>
          Archived Tasks Viewer
          <span class="badge">Read-only</span>
        </h1>
        <div class="header-actions">
          <button id="reload-btn" class="primary btn-sm" type="button">Reload</button>
          <span id="count" class="muted"></span>
          <button id="theme-toggle" class="theme-btn" type="button" aria-label="Toggle theme"></button>
        </div>
      </div>
      <div class="toolbar">
        <div class="field">
          <span>Screen</span>
          <div class="segmented" data-field="screen">
            <button type="button" class="seg-btn" data-value="tasks">Tasks</button>
            <button type="button" class="seg-btn" data-value="calendar">Calendar</button>
          </div>
        </div>
        <div class="field segmented-field hide-when-calendar">
          <span>Group by</span>
          <div class="segmented" data-field="group">
            <button type="button" class="seg-btn" data-value="date">Completion date</button>
            <button type="button" class="seg-btn" data-value="tag">Tag</button>
            <button type="button" class="seg-btn" data-value="project">Project</button>
          </div>
        </div>
        <div class="field segmented-field hide-when-calendar">
          <span>View mode</span>
          <div class="segmented" data-field="view">
            <button type="button" class="seg-btn" data-value="parent">Parent tasks (tree)</button>
            <button type="button" class="seg-btn" data-value="flat">All tasks (flat)</button>
          </div>
        </div>
        <div class="field">
          <span>Filter</span>
          <input id="filter-input" type="search" placeholder="Title, notes, tag, project, subtask..." />
        </div>
      </div>
      <div id="status" class="status">Loading archived tasks...</div>
      <div id="content"></div>
    </div>
    <div id="modal-root"></div>

    <script>
      const state = {
        tasks: [],
        tags: {},
        projects: {},
        taskById: {},
        screen: 'tasks',
        group: 'date',
        filter: '',
        viewTask: null,
        viewMode: 'parent',
        theme: 'dark',
        calendarView: 'week',
        calendarDate: Date.now(),
        locale: navigator.language || 'en-US',
      };

      const waitForPluginApi = async () => {
        while (!window.PluginAPI) {
          await new Promise((r) => setTimeout(r, 50));
        }
        return window.PluginAPI;
      };

      const elStatus = document.getElementById('status');
      const elContent = document.getElementById('content');
      const elCount = document.getElementById('count');
      const elReload = document.getElementById('reload-btn');
      const elFilter = document.getElementById('filter-input');
      const elModalRoot = document.getElementById('modal-root');
      const elScreenSeg = document.querySelector('.segmented[data-field="screen"]');
      const elGroupSeg = document.querySelector('.segmented[data-field="group"]');
      const elViewSeg = document.querySelector('.segmented[data-field="view"]');
      const elThemeToggle = document.getElementById('theme-toggle');

      function prefersDark() {
        return (
          typeof window.matchMedia === 'function' &&
          window.matchMedia('(prefers-color-scheme: dark)').matches
        );
      }

      function getSavedTheme() {
        try {
          const t = localStorage.getItem('avp_theme');
          return t === 'dark' || t === 'light' ? t : null;
        } catch (e) {
          return null;
        }
      }

      function saveTheme(theme) {
        try {
          localStorage.setItem('avp_theme', theme);
        } catch (e) {
          // ignore
        }
      }

      const THEMES = {
        light: {
          bg: '#f8f8f7',
          card: '#ffffff',
          muted: '#4b5563',
          border: 'rgba(0, 0, 0, 0.08)',
          accent: '#3b82f6',
          shadow: '0 6px 18px rgba(0, 0, 0, 0.08)',
          text: '#1f2937',
          surface1: '#f3f4f6',
          surface2: '#eef1f7',
          grad1: 'transparent',
          grad2: 'transparent',
          accentBg: 'rgba(59, 130, 246, 0.12)',
          accentBorder: 'rgba(59, 130, 246, 0.28)',
          accentText: '#1d4ed8',
          focusOutline: 'rgba(59, 130, 246, 0.35)',
          focusShadow: '0 0 0 3px rgba(59, 130, 246, 0.12)',
          backdrop: 'rgba(0, 0, 0, 0.55)',
        },
        dark: {
          bg: '#131314',
          card: '#242424',
          muted: '#cbd5e1',
          border: 'rgba(255, 255, 255, 0.08)',
          accent: '#8ab4ff',
          shadow: '0 12px 32px rgba(0, 0, 0, 0.32)',
          text: '#e8edf7',
          surface1: '#1d1f24',
          surface2: '#272b32',
          grad1: 'transparent',
          grad2: 'transparent',
          accentBg: 'rgba(138, 180, 255, 0.16)',
          accentBorder: 'rgba(138, 180, 255, 0.32)',
          accentText: '#d8e6ff',
          focusOutline: 'rgba(138, 180, 255, 0.38)',
          focusShadow: '0 0 0 3px rgba(138, 180, 255, 0.18)',
          backdrop: 'rgba(0, 0, 0, 0.62)',
        },
      };

      const applyTheme = (mode) => {
        const theme = mode === 'light' ? 'light' : 'dark';
        const vars = THEMES[theme];
        const root = document.documentElement.style;
        Object.entries({
          '--bg': vars.bg,
          '--card': vars.card,
          '--muted': vars.muted,
          '--border': vars.border,
          '--accent': vars.accent,
          '--shadow': vars.shadow,
          '--text': vars.text,
          '--surface-1': vars.surface1,
          '--surface-2': vars.surface2,
          '--grad1': vars.grad1,
          '--grad2': vars.grad2,
          '--accent-bg': vars.accentBg,
          '--accent-border': vars.accentBorder,
          '--accent-text': vars.accentText,
          '--focus-outline': vars.focusOutline,
          '--focus-shadow': vars.focusShadow,
          '--backdrop': vars.backdrop,
        }).forEach(([k, v]) => root.setProperty(k, v));

        elThemeToggle.dataset.theme = theme;
        elThemeToggle.innerHTML =
          theme === 'dark'
            ? `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" aria-hidden=\"true\"><path d=\"M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8Z\"/></svg><span class=\"theme-label\">Dark</span>`
            : `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" aria-hidden=\"true\"><circle cx=\"12\" cy=\"12\" r=\"4\"/><path d=\"M12 2v2\"/><path d=\"M12 20v2\"/><path d=\"M4.93 4.93l1.41 1.41\"/><path d=\"M17.66 17.66l1.41 1.41\"/><path d=\"M2 12h2\"/><path d=\"M20 12h2\"/><path d=\"M4.93 19.07l1.41-1.41\"/><path d=\"M17.66 6.34l1.41-1.41\"/></svg><span class=\"theme-label\">Light</span>`;
      };

      const setSegmentedValue = (container, value) => {
        if (!container) return;
        container.querySelectorAll('.seg-btn').forEach((btn) => {
          btn.classList.toggle('active', btn.dataset.value === value);
        });
      };

      const wireSegmented = (container, onChange) => {
        if (!container) return;
        container.querySelectorAll('.seg-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            const val = btn.dataset.value;
            setSegmentedValue(container, val);
            onChange(val);
          });
        });
      };

      const getLocale = () => state.locale || navigator.language || 'en-US';

      const formatDate = (ts) => {
        if (!ts) return '-';
        const d = new Date(ts);
        return isNaN(d.getTime()) ? '-' : d.toLocaleDateString(getLocale());
      };
      const formatTime = (ts) => {
        if (!ts) return '';
        const d = new Date(ts);
        return isNaN(d.getTime())
          ? ''
          : d.toLocaleTimeString(getLocale(), { hour: '2-digit', minute: '2-digit' });
      };

      const startOfDay = (d) => {
        const nd = new Date(d);
        nd.setHours(0, 0, 0, 0);
        return nd;
      };
      const formatDayKey = (d) => startOfDay(d).toISOString().slice(0, 10);
      const addDays = (d, n) => {
        const nd = new Date(d);
        nd.setDate(nd.getDate() + n);
        return nd;
      };
      const addMonths = (d, n) => {
        const nd = new Date(d);
        nd.setMonth(nd.getMonth() + n);
        return nd;
      };
      const startOfWeek = (d) => {
        const nd = startOfDay(d);
        const day = nd.getDay(); // 0 Sunday
        const diff = (day === 0 ? -6 : 1 - day);
        return addDays(nd, diff);
      };
      const startOfMonth = (d) => {
        const nd = startOfDay(d);
        nd.setDate(1);
        return nd;
      };
      const isSameDay = (a, b) => formatDayKey(a) === formatDayKey(b);
      const isToday = (d) => isSameDay(d, new Date());
      const formatDayLabel = (d) =>
        d.toLocaleDateString(getLocale(), { weekday: 'short', month: 'short', day: 'numeric' });
      const formatDayLabelLocale = (d, locale) =>
        d.toLocaleDateString(locale, { weekday: 'short', month: 'short', day: 'numeric' });
      const formatTimeLocale = (ts, locale) => {
        if (!ts) return '';
        const d = new Date(ts);
        return isNaN(d.getTime())
          ? ''
          : d.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
      };
      const getWeekDays = (base) => {
        const start = startOfWeek(base);
        return Array.from({ length: 7 }, (_, i) => addDays(start, i));
      };
      const getMonthDays = (base) => {
        const startMonth = startOfMonth(base);
        const lastOfMonth = addDays(addMonths(startMonth, 1), -1);
        const startGrid = startOfWeek(startMonth);
        const days = [];
        let cursor = startGrid;
        while (true) {
          days.push(cursor);
          cursor = addDays(cursor, 1);
          if (cursor > lastOfMonth && cursor.getDay() === 1) {
            break;
          }
        }
        return days;
      };

      const formatMs = (ms) => {
        if (!ms) return '-';
        const sec = Math.floor(ms / 1000);
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        const parts = [];
        if (h) parts.push(h + 'h');
        if (m) parts.push(m + 'm');
        if (s || parts.length === 0) parts.push(s + 's');
        return parts.join(' ');
      };

      const unassigned = 'Unassigned';

      const formatTags = (task) => {
        const ids = task.tagIds || [];
        return ids.map((id) => state.tags[id] || unassigned).filter(Boolean);
      };

      const textIncludes = (text, term) => (text || '').toLowerCase().includes(term);

      const updateVisibility = () => {
        const hideOnCal = document.querySelectorAll('.hide-when-calendar');
        hideOnCal.forEach((el) => {
          el.classList.toggle('hide', state.screen === 'calendar');
        });
      };

      const matchTask = (t, q) => {
        if (!q) return true;
        const tagText = formatTags(t).join(' ');
        const projectText = t.projectId ? state.projects[t.projectId] || '' : '';
        return (
          textIncludes(t.title, q) ||
          textIncludes(t.notes, q) ||
          textIncludes(tagText, q) ||
          textIncludes(projectText, q)
        );
      };

      const buildTree = (tasks) => {
        const map = new Map();
        tasks.forEach((t) => map.set(t.id, { ...t, children: [] }));
        const roots = [];
        map.forEach((t) => {
          if (t.parentId && map.has(t.parentId)) {
            map.get(t.parentId).children.push(t);
          } else {
            roots.push(t);
          }
        });
        return roots;
      };

      const filterTree = (nodes, term) => {
        const q = term?.toLowerCase?.() || '';
        const walk = (node, depth = 0) => {
          const kids = (node.children || []).map((c) => walk(c, depth + 1)).filter(Boolean);
          const selfMatch = matchTask(node, q);
          if (selfMatch || kids.length) {
            return { ...node, children: kids };
          }
          return null;
        };
        return nodes.map((n) => walk(n)).filter(Boolean);
      };

      const flatten = (nodes) => {
        const res = [];
        const walk = (n) => {
          res.push(n);
          (n.children || []).forEach(walk);
        };
        nodes.forEach(walk);
        return res;
      };

      const filterTasks = (tasks, term) => {
        if (!term) return tasks;
        const q = term.toLowerCase();
        return tasks.filter((t) => matchTask(t, q));
      };

      const getDoneOn = (t) => (typeof t.doneOn === 'number' ? t.doneOn : t.created || Date.now());

      function groupTasks(tasks, mode) {
        const groups = new Map();
        for (const task of tasks) {
          const key =
            mode === 'date'
              ? new Date(getDoneOn(task)).toISOString().slice(0, 10)
              : mode === 'tag'
              ? (task.tagIds && task.tagIds[0]) || unassigned
              : task.projectId || unassigned;

          if (!groups.has(key)) {
            groups.set(key, { key, tasks: [] });
          }
          groups.get(key).tasks.push(task);
        }

        return Array.from(groups.values())
          .map((g) => ({
            key: g.key,
            label:
              mode === 'date'
                ? g.key
                : mode === 'tag'
                ? state.tags[g.key] || unassigned
                : state.projects[g.key] || unassigned,
            tasks: g.tasks.sort((a, b) => getDoneOn(b) - getDoneOn(a)),
          }))
          .sort((a, b) => {
            if (mode === 'date') {
              return new Date(b.key).getTime() - new Date(a.key).getTime();
            }
            return a.label.localeCompare(b.label);
          });
      }

      function render() {
        const tree = buildTree(state.tasks);
        const filteredTree = filterTree(tree, state.filter);
        const flatAll = flatten(tree);
        const filteredFlat = filterTasks(flatAll, state.filter);

        if (!state.tasks.length) {
          elStatus.textContent = 'No archived tasks found.';
          elContent.innerHTML = '';
          elCount.textContent = '';
          renderDetail();
          return;
        }
        if (state.screen === 'calendar') {
          elCount.textContent = `${filteredFlat.length} of ${state.tasks.length} tasks`;
          if (!filteredFlat.length) {
            elStatus.textContent = 'No tasks match the current filter.';
            elContent.innerHTML = '';
            renderDetail();
            return;
          }
          elStatus.textContent = '';
          renderCalendar(filteredFlat);
          renderDetail();
          return;
        }

        const filteredForView =
          state.viewMode === 'flat' ? filteredFlat : flatten(filteredTree);

        if (!filteredForView.length) {
          elStatus.textContent = 'No tasks match the current filter.';
          elContent.innerHTML = '';
          elCount.textContent = `${filteredForView.length} of ${state.tasks.length} tasks`;
          renderDetail();
          return;
        }

        elStatus.textContent = '';
        const listToGroup = state.viewMode === 'parent' ? filteredTree : filteredFlat;
        const groups = groupTasks(listToGroup, state.group);
        elCount.textContent = `${filteredForView.length} of ${state.tasks.length} tasks`;

        const frag = document.createDocumentFragment();
        groups.forEach((group) => {
          const section = document.createElement('section');
          section.className = 'group';

          const header = document.createElement('div');
          header.className = 'group-header';
          const title = document.createElement('div');
          title.className = 'group-title';
          title.textContent = group.label;
          const count = document.createElement('span');
          count.className = 'muted';
          count.textContent = `${group.tasks.length} task(s)`;
          header.appendChild(title);
          header.appendChild(count);
          section.appendChild(header);

          const list = document.createElement('div');
          list.className = 'list';
          group.tasks.forEach((task) =>
            list.appendChild(renderTask(task, state.viewMode === 'parent')),
          );
          section.appendChild(list);

          frag.appendChild(section);
        });

        elContent.innerHTML = '';
        elContent.appendChild(frag);
        renderDetail();
      }

      function renderCalendar(tasks) {
        const calLocale = 'en-US';
        const byDay = new Map();
        tasks.forEach((t) => {
          const key = formatDayKey(getDoneOn(t));
          if (!byDay.has(key)) byDay.set(key, []);
          byDay.get(key).push(t);
        });
        byDay.forEach((arr) => arr.sort((a, b) => getDoneOn(a) - getDoneOn(b)));

        const baseDate = new Date(state.calendarDate);
        const isWeek = state.calendarView === 'week';
        const days = isWeek ? getWeekDays(baseDate) : getMonthDays(baseDate);
        const rangeLabel = isWeek
          ? `${formatDayLabelLocale(days[0], calLocale)} - ${formatDayLabelLocale(
              days[days.length - 1],
              calLocale,
            )}`
          : baseDate.toLocaleDateString(calLocale, { month: 'long', year: 'numeric' });

        const container = document.createElement('div');

        const toolbar = document.createElement('div');
        toolbar.className = 'calendar-toolbar';

        const left = document.createElement('div');
        left.className = 'left';
        const label = document.createElement('span');
        label.className = 'range-label';
        label.textContent = rangeLabel;
        left.appendChild(label);

        const viewSeg = document.createElement('div');
        viewSeg.className = 'segmented seg-compact';
        ['week', 'month'].forEach((mode) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'seg-btn';
          btn.dataset.value = mode;
          btn.textContent = mode === 'week' ? 'Week' : 'Month';
          btn.classList.toggle('active', state.calendarView === mode);
          btn.addEventListener('click', () => {
            state.calendarView = mode;
            render();
          });
          viewSeg.appendChild(btn);
        });
        left.appendChild(viewSeg);

        const right = document.createElement('div');
        right.className = 'right';
        const prev = document.createElement('button');
        prev.type = 'button';
        prev.className = 'ghost btn-sm';
        prev.textContent = 'Prev';
        prev.addEventListener('click', () => {
          const nextDate =
            state.calendarView === 'week'
              ? addDays(baseDate, -7)
              : addMonths(baseDate, -1);
          state.calendarDate = nextDate.getTime();
          render();
        });
        const today = document.createElement('button');
        today.type = 'button';
        today.className = 'ghost btn-sm';
        today.textContent = 'Today';
        today.addEventListener('click', () => {
          state.calendarDate = Date.now();
          render();
        });
        const next = document.createElement('button');
        next.type = 'button';
        next.className = 'ghost btn-sm';
        next.textContent = 'Next';
        next.addEventListener('click', () => {
          const nextDate =
            state.calendarView === 'week'
              ? addDays(baseDate, 7)
              : addMonths(baseDate, 1);
          state.calendarDate = nextDate.getTime();
          render();
        });
        right.appendChild(prev);
        right.appendChild(today);
        right.appendChild(next);

        toolbar.appendChild(left);
        toolbar.appendChild(right);

        const grid = document.createElement('div');
        grid.className = 'calendar-grid';

        days.forEach((day) => {
          const key = formatDayKey(day);
          const dayTasks = byDay.get(key) || [];

          const col = document.createElement('div');
          col.className = `calendar-day ${isWeek ? 'calendar-day-week' : 'calendar-day-month'}`;
          if (isToday(day)) {
            col.classList.add('today');
          }

          const header = document.createElement('div');
          header.className = 'calendar-day-header';
          const leftH = document.createElement('span');
          leftH.textContent = day.toLocaleDateString(calLocale, { weekday: 'short' });
          const rightH = document.createElement('span');
          rightH.className = 'muted';
          rightH.textContent = day.getDate();
          header.appendChild(leftH);
          header.appendChild(rightH);
          col.appendChild(header);

          const body = document.createElement('div');
          body.className = 'calendar-day-body';

          if (!dayTasks.length) {
            const empty = document.createElement('div');
            empty.className = 'calendar-empty';
            empty.textContent = 'No tasks';
            body.appendChild(empty);
          } else {
            dayTasks.forEach((task) => {
              const item = document.createElement('div');
              item.className = 'calendar-task';
              const title = document.createElement('p');
              title.className = 'calendar-task-title';
              title.textContent = task.title || '(untitled)';
              item.appendChild(title);
              item.addEventListener('click', () => openDetail(task, false));
              body.appendChild(item);
            });
          }

          col.appendChild(body);
          grid.appendChild(col);
        });

        container.appendChild(toolbar);
        container.appendChild(grid);

        elContent.innerHTML = '';
        elContent.appendChild(container);
      }

      function renderTask(task, isTree) {
        const card = document.createElement('article');
        card.className = 'task-row';

        const accent = document.createElement('div');
        accent.className = 'task-accent';
        card.appendChild(accent);

        const main = document.createElement('div');
        main.className = 'task-main';
        card.appendChild(main);

        const header = document.createElement('div');
        header.className = 'task-header';
        const title = document.createElement('p');
        title.className = 'task-title';
        title.textContent = task.title || '(untitled)';
        const statusWrap = document.createElement('div');
        statusWrap.className = 'row-actions';
        const doneOn = document.createElement('span');
        doneOn.className = 'pill accent';
        doneOn.textContent = formatDate(task.doneOn);
        statusWrap.appendChild(doneOn);
        header.appendChild(title);
        header.appendChild(statusWrap);
        main.appendChild(header);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <span>Project: ${task.projectId ? state.projects[task.projectId] || unassigned : unassigned}</span>
          <span>Submitted: ${formatDate(task.created)}</span>
        `;
        main.appendChild(meta);

        const tags = formatTags(task);
        if (tags.length) {
          const tagWrap = document.createElement('div');
          tagWrap.className = 'chips';
          tags.forEach((t) => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.textContent = t;
            tagWrap.appendChild(chip);
          });
          main.appendChild(tagWrap);
        }

        // Brief subtask preview: title + done date
        const previewSubs = isTree ? task.children || [] : task.subTasks || [];
        if (previewSubs.length) {
          const box = document.createElement('div');
          box.className = 'subtask-preview';
          const label = document.createElement('span');
          label.className = 'muted';
          label.textContent = `Subtasks (${previewSubs.length})`;
          box.appendChild(label);
          previewSubs.slice(0, 2).forEach((st) => {
            const row = document.createElement('span');
            row.className = 'subtask-pill';
            const name = document.createElement('span');
            name.className = 'subtask-title';
            name.textContent = st.title || '(untitled)';
            const done = document.createElement('span');
            done.className = 'muted';
            done.textContent = formatDate(st.doneOn);
            row.appendChild(name);
            row.appendChild(done);
            box.appendChild(row);
          });
          if (previewSubs.length > 2) {
            const more = document.createElement('span');
            more.className = 'muted';
            more.textContent = `+${previewSubs.length - 2} more`;
            box.appendChild(more);
          }
          main.appendChild(box);
        }

        const footer = document.createElement('div');
        footer.className = 'task-footer';
        const footerMeta = document.createElement('div');
        footerMeta.className = 'meta tight';
        footerMeta.innerHTML = `
          <span>Done: ${formatDate(task.doneOn)}</span>
          <span>Time spent: ${formatMs(task.timeSpent)}</span>
          <span>Estimate: ${formatMs(task.timeEstimate)}</span>
        `;
        const actions = document.createElement('div');
        actions.className = 'actions tight';

        const viewBtn = document.createElement('button');
        viewBtn.className = 'ghost';
        viewBtn.textContent = 'View details';
        viewBtn.addEventListener('click', () => openDetail(task, isTree));

        actions.appendChild(viewBtn);
        footer.appendChild(footerMeta);
        footer.appendChild(actions);
        main.appendChild(footer);

        return card;
      }

      function renderTree(children, depth = 1) {
        const wrap = document.createElement('div');
        wrap.className = 'tree';
        children.forEach((child) => {
          const row = document.createElement('div');
          row.className = `tree-row tree-indent-${Math.min(depth, 4)}`;
          const name = document.createElement('div');
          name.className = 'tree-title';
          name.textContent = child.title || '(untitled)';
          const time = document.createElement('span');
          time.className = 'muted';
          time.textContent = formatMs(child.timeSpent);
          const status = document.createElement('span');
          status.className = 'pill';
          status.textContent = child.isDone ? 'Done' : 'Open';
          const done = document.createElement('span');
          done.className = 'muted';
          done.textContent = formatDate(child.doneOn);
          const details = document.createElement('button');
          details.className = 'ghost btn-xs';
          details.type = 'button';
          details.textContent = 'Details';
          details.addEventListener('click', (e) => {
            e.stopPropagation();
            openDetail(child, true);
          });
          row.appendChild(name);
          row.appendChild(status);
          row.appendChild(done);
          row.appendChild(time);
          row.appendChild(details);
          row.style.cursor = 'pointer';
          row.addEventListener('click', () => openDetail(child, true));
          wrap.appendChild(row);
          if (child.children && child.children.length) {
            wrap.appendChild(renderTree(child.children, depth + 1));
          }
        });
        return wrap;
      }

      function renderDetail() {
        elModalRoot.innerHTML = '';
        if (!state.viewTask) return;

        const task = state.viewTask;
        const overlay = document.createElement('div');
        overlay.className = 'backdrop';
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) closeDetail();
        });

        const modal = document.createElement('div');
        modal.className = 'modal';

        const header = document.createElement('div');
        header.className = 'modal-header';
        const title = document.createElement('div');
        title.innerHTML = `<div class="muted" style="margin-bottom:4px;">Archived task</div><div style="font-size:18px;font-weight:800;line-height:1.4;">${task.title || '(untitled)'}</div>`;
        const close = document.createElement('button');
        close.className = 'close-btn';
        close.textContent = 'Close';
        close.addEventListener('click', closeDetail);
        header.appendChild(title);
        header.appendChild(close);
        modal.appendChild(header);

        const kv = document.createElement('div');
        kv.className = 'kv';
        kv.appendChild(kvItem('Status', task.isDone ? 'Done' : 'Open'));
        kv.appendChild(kvItem('Done on', formatDate(task.doneOn)));
        if (task.parentId && state.taskById[task.parentId]) {
          kv.appendChild(kvItem('Parent', state.taskById[task.parentId].title || '(untitled)'));
        }
        kv.appendChild(kvItem('Project', task.projectId ? state.projects[task.projectId] || unassigned : unassigned));
        kv.appendChild(kvItem('Tags', formatTags(task).join(', ') || unassigned));
        kv.appendChild(kvItem('Issue', task.issueId || '-'));
        kv.appendChild(kvItem('Time spent', formatMs(task.timeSpent)));
        kv.appendChild(kvItem('Estimate', formatMs(task.timeEstimate)));
        kv.appendChild(kvItem('Created', formatDate(task.created)));
        modal.appendChild(kv);

        if (task.notes) {
          const notesBox = document.createElement('div');
          notesBox.className = 'section';
          const label = document.createElement('div');
          label.className = 'section-title';
          label.textContent = 'Notes';
          const notes = document.createElement('p');
          notes.className = 'notes';
          notes.textContent = task.notes;
          notesBox.appendChild(label);
          notesBox.appendChild(notes);
          modal.appendChild(notesBox);
        }

        const subs = task.children || task.subTasks || [];
        if (subs.length) {
          const subBox = document.createElement('div');
          subBox.className = 'section subtasks';
          const label = document.createElement('div');
          label.className = 'section-title';
          label.textContent = `Subtasks (${subs.length})`;
          subBox.appendChild(label);
          subBox.appendChild(renderTree(subs, 1));
          modal.appendChild(subBox);
        }

        const atts = task.attachments || [];
        if (atts.length) {
          const attBox = document.createElement('div');
          attBox.className = 'section attachments';
          const label = document.createElement('div');
          label.className = 'section-title';
          label.textContent = `Attachments (${atts.length})`;
          attBox.appendChild(label);
          atts.forEach((att) => {
            const row = document.createElement('div');
            row.className = 'attachment';
            const link = document.createElement('a');
            link.href = att.path || '#';
            link.target = '_blank';
            link.rel = 'noreferrer';
            link.textContent = att.title || att.path || '(attachment)';
            const type = document.createElement('span');
            type.className = 'muted';
            type.textContent = att.type || '';
            row.appendChild(link);
            row.appendChild(type);
            attBox.appendChild(row);
          });
          modal.appendChild(attBox);
        }

        overlay.appendChild(modal);
        elModalRoot.appendChild(overlay);
      }

      function kvItem(label, value) {
        const wrap = document.createElement('div');
        wrap.className = 'kv-item';
        const l = document.createElement('div');
        l.className = 'kv-label';
        l.textContent = label;
        const v = document.createElement('div');
        v.className = 'kv-value';
        v.textContent = value;
        wrap.appendChild(l);
        wrap.appendChild(v);
        return wrap;
      }

      function attachChildren(task) {
        // Build tree and return node with its children (if any)
        const map = new Map();
        state.tasks.forEach((t) => map.set(t.id, { ...t, children: [] }));
        map.forEach((t) => {
          if (t.parentId && map.has(t.parentId)) {
            map.get(t.parentId).children.push(t);
          }
        });
        return map.get(task.id) || task;
      }

      function openDetail(task, isTree) {
        if (!task) return;
        state.viewTask = isTree ? task : attachChildren(task);
        renderDetail();
      }

      function closeDetail() {
        state.viewTask = null;
        renderDetail();
      }

      async function loadData() {
        elStatus.textContent = 'Loading archived tasks...';
        elContent.innerHTML = '';
        try {
          const PluginAPI = await waitForPluginApi();
          const [tasks, tags, projects] = await Promise.all([
            PluginAPI.getArchivedTasks(),
            PluginAPI.getAllTags(),
            PluginAPI.getAllProjects(),
          ]);
          state.locale = PluginAPI?.cfg?.lang?.code || navigator.language || 'en-US';
          state.tasks = tasks || [];
          state.taskById = Object.fromEntries(state.tasks.map((t) => [t.id, t]));
          state.tags = Object.fromEntries(tags.map((t) => [t.id, t.title]));
          state.projects = Object.fromEntries(projects.map((p) => [p.id, p.title]));
          render();
        } catch (err) {
          console.error(err);
          elStatus.textContent = 'Failed to load archived tasks.';
          elContent.innerHTML = '';
        }
      }

      elReload.addEventListener('click', () => loadData());

      elFilter.addEventListener('input', (e) => {
        state.filter = e.target.value.trim();
        render();
      });

      elThemeToggle.addEventListener('click', () => {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        applyTheme(state.theme);
        saveTheme(state.theme);
      });

      wireSegmented(elGroupSeg, (val) => {
        state.group = val;
        render();
      });

      wireSegmented(elViewSeg, (val) => {
        state.viewMode = val;
        render();
      });

      wireSegmented(elScreenSeg, (val) => {
        state.screen = val;
        updateVisibility();
        render();
      });

      setSegmentedValue(elScreenSeg, state.screen);
      setSegmentedValue(elGroupSeg, state.group);
      setSegmentedValue(elViewSeg, state.viewMode);

      // kick off
      state.theme = getSavedTheme() || (prefersDark() ? 'dark' : 'light');
      applyTheme(state.theme);
      updateVisibility();
      loadData();
    </script>
  </body>
</html>
